<!--
Copyright (c) 2025 Northbound System
Author: Nicholas Skitch
-->
{{ define "title" }}Settings - The Hive{{ end }}

{{ define "head" }}
    <style>
        .terminal {
            background-color: #1a1a1a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            padding: 16px;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.5;
        }
        .log-line {
            margin: 2px 0;
            word-wrap: break-word;
        }
        .log-error { color: #ff4444; }
        .log-warn { color: #ffaa00; }
        .log-info { color: #00ff00; }
        .log-debug { color: #888888; }
    </style>
{{ end }}

{{ define "content" }}
<div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="mb-6">
            <h1 class="text-3xl font-bold text-gray-900">‚öôÔ∏è Settings</h1>
        </div>

        <!-- Tabs Navigation -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="flex space-x-8" aria-label="Tabs">
                <button onclick="showTab('settings')" id="tab-settings" class="tab-button border-b-2 border-blue-500 py-4 px-1 text-sm font-medium text-blue-600">
                    ‚öôÔ∏è Settings
                </button>
                <button onclick="showTab('audit')" id="tab-audit" class="tab-button border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    üìã Audit Log
                </button>
            </nav>
        </div>

        <!-- Settings Tab Content -->
        <div id="content-settings" class="tab-content">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Configuration Form -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">Configuration</h2>
                
                <form id="configForm" class="space-y-4">
                    <!-- AI Provider -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">AI Provider</label>
                        <select id="aiProvider" name="ai_provider" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="openai">OpenAI</option>
                            <option value="gemini">Gemini</option>
                            <option value="mock">Mock (Testing)</option>
                        </select>
                    </div>

                    <!-- API Key -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                        <div class="flex gap-2">
                            <input 
                                type="password" 
                                id="apiKey" 
                                name="api_key"
                                placeholder="Enter your API key..."
                                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            />
                            <button 
                                type="button"
                                onclick="toggleApiKey()"
                                class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
                            >
                                <span id="toggleText">Show</span>
                            </button>
                        </div>
                    </div>

                    <!-- Qdrant URL -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Qdrant URL</label>
                        <input 
                            type="text" 
                            id="qdrantUrl" 
                            name="qdrant_url"
                            placeholder="localhost:6334"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                    </div>

                    <!-- Redis URL -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Redis URL</label>
                        <input 
                            type="text" 
                            id="redisUrl" 
                            name="redis_url"
                            placeholder="localhost:6379"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                    </div>

                    <!-- Northbound License Key -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Northbound License Key</label>
                        <input 
                            type="password" 
                            id="licenseKey" 
                            name="license_key"
                            placeholder="Enter your commercial license key..."
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                        <p class="text-xs text-gray-500 mt-1">Required after 365-day evaluation period</p>
                    </div>

                    <button 
                        type="submit"
                        class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors"
                    >
                        Save Configuration
                    </button>
                </form>

                <div id="saveStatus" class="mt-4"></div>
            </div>

            <!-- API Key Management -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">üîë Client API Key Management</h2>
                <p class="text-sm text-gray-600 mb-4">Generate and manage API keys for drone client authentication.</p>
                
                <div class="mb-4">
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="newClientName" 
                               placeholder="Client name (e.g., Production Client)"
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <button onclick="generateKey()" 
                                class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm font-semibold">
                            Generate New Key
                        </button>
                    </div>
                    <div id="newKeyDisplay" class="mt-2 hidden">
                        <div class="bg-yellow-50 border border-yellow-200 rounded p-3">
                            <p class="text-sm font-semibold text-yellow-800 mb-1">New API Key Generated:</p>
                            <code id="newKeyValue" class="text-sm text-gray-900 break-all"></code>
                            <p class="text-xs text-yellow-700 mt-2">‚ö†Ô∏è Copy this key now - it won't be shown again!</p>
                        </div>
                    </div>
                </div>
                
                <div id="apiKeysList" class="space-y-2">
                    <p class="text-gray-500 text-sm">Loading keys...</p>
                </div>
            </div>

            <!-- Semantic Rules -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">üîç Semantic Rules (Analyst)</h2>
                <p class="text-sm text-gray-600 mb-4">Define yes/no questions that will be checked against ingested documents. When a rule matches, an alert will be sent to the client.</p>
                <p class="text-xs text-gray-500 mb-4 italic">Example: "Does this document mention Nicholas?" - The AI will analyze each ingested file and send an alert if the answer is YES.</p>
                
                <div id="rulesList" class="mb-4 space-y-2">
                    <p class="text-gray-500 text-sm">Loading rules...</p>
                </div>
                
                <div class="border-t pt-4">
                    <h3 class="text-sm font-medium mb-2">Add New Rule</h3>
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="newRuleQuery" 
                               placeholder="e.g., Does this document mention Nicholas?"
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="flex items-center gap-2 mb-2">
                        <input type="checkbox" id="newRuleActive" checked class="rounded">
                        <label for="newRuleActive" class="text-sm text-gray-700">Active</label>
                    </div>
                    <button type="button" id="addRuleButton" onclick="addRule(event)" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                        Add Rule
                    </button>
                </div>
            </div>

            <!-- System Stats -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">System Statistics</h2>
                <div id="statsContainer" class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-700">Vectors in Memory:</span>
                        <span id="vectorCount" class="font-semibold text-blue-600">Loading...</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-700">Database Status:</span>
                        <span id="dbStatus" class="font-semibold">Loading...</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-700">Evaluation Mode:</span>
                        <span id="trialDays" class="font-semibold text-orange-600">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Live Logs -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">Live Logs</h2>
                <div id="logContainer" class="terminal">
                    <div class="log-line">Waiting for logs...</div>
                </div>
                <div class="mt-2 flex gap-2">
                    <button 
                        onclick="clearLogs()"
                        class="px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300"
                    >
                        Clear
                    </button>
                    <span id="logStatus" class="text-sm text-gray-500">Connecting...</span>
                </div>
            </div>
        </div>
        </div>

        <!-- Audit Tab Content -->
        <div id="content-audit" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">üìã Audit Log</h2>
                <p class="text-sm text-gray-600 mb-4">View the last 50 system activities including searches and file uploads.</p>
                
                <div class="mb-4">
                    <button onclick="loadAuditLogs()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-semibold">
                        üîÑ Refresh
                    </button>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client IP</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                            </tr>
                        </thead>
                        <tbody id="auditLogsTable" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="4" class="px-6 py-4 text-center text-gray-500">Loading audit logs...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let eventSource = null;
        let apiKeyVisible = false;

        // Load current configuration
        async function loadConfig() {
            try {
                const response = await fetch('/api/v1/config');
                const config = await response.json();
                
                document.getElementById('aiProvider').value = config.ai_provider || 'openai';
                document.getElementById('apiKey').value = config.api_key || '';
                document.getElementById('qdrantUrl').value = config.qdrant_url || 'localhost:6334';
                document.getElementById('redisUrl').value = config.redis_url || 'localhost:6379';
                const licenseKeyInput = document.getElementById('licenseKey');
                if (licenseKeyInput) {
                    licenseKeyInput.value = config.license_key || '';
                }
            } catch (error) {
                console.error('Failed to load config:', error);
            }
        }

        // Toggle API key visibility
        function toggleApiKey() {
            const input = document.getElementById('apiKey');
            const toggleText = document.getElementById('toggleText');
            apiKeyVisible = !apiKeyVisible;
            
            if (apiKeyVisible) {
                input.type = 'text';
                toggleText.textContent = 'Hide';
            } else {
                input.type = 'password';
                toggleText.textContent = 'Show';
            }
        }


        // Save configuration
        document.getElementById('configForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const aiProvider = document.getElementById('aiProvider').value;
            const apiKey = document.getElementById('apiKey').value.trim();
            
            // Frontend validation
            if (apiKey) {
                if (aiProvider === 'openai' && !apiKey.startsWith('sk-')) {
                    alert('Invalid OpenAI Key format. OpenAI API keys must start with "sk-"');
                    return;
                }
                if (aiProvider === 'gemini' && !apiKey.startsWith('AI')) {
                    alert('Invalid Gemini Key format. Gemini API keys must start with "AI"');
                    return;
                }
            }
            
            const formData = {
                ai_provider: aiProvider,
                api_key: apiKey,
                qdrant_url: document.getElementById('qdrantUrl').value,
                redis_url: document.getElementById('redisUrl').value,
                license_key: document.getElementById('licenseKey')?.value || '',
            };

            try {
                const response = await fetch('/api/v1/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData),
                });

                const result = await response.json();
                const statusDiv = document.getElementById('saveStatus');
                
                if (response.ok) {
                    statusDiv.innerHTML = '<div class="text-green-600 text-sm">‚úì Configuration saved successfully</div>';
                } else {
                    statusDiv.innerHTML = `<div class="text-red-600 text-sm">‚úó Error: ${result.error || 'Failed to save'}</div>`;
                }
                
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 3000);
            } catch (error) {
                console.error('Failed to save config:', error);
                document.getElementById('saveStatus').innerHTML = '<div class="text-red-600 text-sm">‚úó Failed to save configuration</div>';
            }
        });

        // Connect to log stream
        function connectLogStream() {
            if (eventSource) {
                eventSource.close();
            }

            eventSource = new EventSource('/api/v1/logs/stream');
            const logContainer = document.getElementById('logContainer');
            const logStatus = document.getElementById('logStatus');

            eventSource.onopen = function() {
                logStatus.textContent = 'Connected';
                logStatus.className = 'text-sm text-green-600';
            };

            eventSource.onmessage = function(event) {
                const logLine = document.createElement('div');
                logLine.className = 'log-line';
                
                // Determine log level and color
                const message = event.data;
                if (message.includes('[ERROR]') || message.includes('[FATAL]')) {
                    logLine.className += ' log-error';
                } else if (message.includes('[WARN]')) {
                    logLine.className += ' log-warn';
                } else if (message.includes('[DEBUG]')) {
                    logLine.className += ' log-debug';
                } else {
                    logLine.className += ' log-info';
                }
                
                logLine.textContent = message;
                logContainer.appendChild(logLine);
                
                // Auto-scroll to bottom
                logContainer.scrollTop = logContainer.scrollHeight;
                
                // Keep only last 500 lines
                while (logContainer.children.length > 500) {
                    logContainer.removeChild(logContainer.firstChild);
                }
            };

            eventSource.onerror = function(error) {
                logStatus.textContent = 'Disconnected - Reconnecting...';
                logStatus.className = 'text-sm text-yellow-600';
                // Reconnect after 3 seconds
                setTimeout(connectLogStream, 3000);
            };
        }

        // Clear logs
        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '<div class="log-line">Logs cleared...</div>';
        }

        // Load and update stats
        async function loadStats() {
            try {
                const response = await fetch('/api/v1/stats');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const stats = await response.json();
                // Stats received
                
                // Validate field names match API response
                if (stats.vectors_in_memory === undefined) {
                    console.error("Field mismatch: vectors_in_memory not found in response. Available fields:", Object.keys(stats));
                }
                if (stats.database_status === undefined) {
                    console.error("Field mismatch: database_status not found in response. Available fields:", Object.keys(stats));
                }
                
                // Update vector count - use exact API field name with defensive check
                const vectorCountEl = document.getElementById('vectorCount');
                if (!vectorCountEl) {
                    console.error("Critical: DOM element 'vectorCount' not found in HTML");
                } else {
                    if (stats.vectors_in_memory !== undefined && stats.vectors_in_memory >= 0) {
                        vectorCountEl.textContent = stats.vectors_in_memory.toLocaleString();
                        vectorCountEl.className = 'font-semibold text-gray-900';
                    } else if (stats.vectors_in_memory === undefined) {
                        vectorCountEl.textContent = 'Error';
                        vectorCountEl.className = 'font-semibold text-red-600';
                        console.error('Stats error: vectors_in_memory field missing from API response');
                    } else {
                        vectorCountEl.textContent = 'Error';
                        vectorCountEl.className = 'font-semibold text-red-600';
                        console.error('Stats error: vectors_in_memory is negative, indicating Qdrant connection issue');
                    }
                }
                
                // Update database status - use exact API field name with defensive check
                const dbStatusEl = document.getElementById('dbStatus');
                if (!dbStatusEl) {
                    console.error("Critical: DOM element 'dbStatus' not found in HTML");
                } else {
                    if (stats.database_status === undefined) {
                        dbStatusEl.textContent = 'Error';
                        dbStatusEl.className = 'font-semibold text-red-600';
                        console.error('Stats error: database_status field missing from API response');
                    } else if (stats.database_status === 'connected') {
                        dbStatusEl.textContent = 'Connected';
                        dbStatusEl.className = 'font-semibold text-green-600';
                    } else if (stats.database_status === 'disconnected' || stats.database_status === 'error') {
                        dbStatusEl.textContent = 'Disconnected';
                        dbStatusEl.className = 'font-semibold text-red-600';
                    } else {
                        dbStatusEl.textContent = stats.database_status;
                        dbStatusEl.className = 'font-semibold text-yellow-600';
                    }
                }
                
                // Update trial days with defensive check
                const trialDaysEl = document.getElementById('trialDays');
                const days = stats.trial_days || 0;
                if (!trialDaysEl) {
                    console.error("Critical: DOM element 'trialDays' not found in HTML");
                } else {
                    if (days > 365) {
                        trialDaysEl.textContent = `Day ${days} of 365 (Expired)`;
                        trialDaysEl.className = 'font-semibold text-red-600';
                    } else {
                        trialDaysEl.textContent = `Day ${days} of 365`;
                        trialDaysEl.className = 'font-semibold text-orange-600';
                    }
                }
                
                // Update footer evaluation status
                const evalStatusEl = document.getElementById('evaluationStatus');
                if (evalStatusEl) {
                    if (days > 365) {
                        evalStatusEl.textContent = `Evaluation Mode: Day ${days} of 365 (Expired - License Required)`;
                        evalStatusEl.className = 'text-red-600 font-semibold';
                    } else {
                        evalStatusEl.textContent = `Evaluation Mode: Day ${days} of 365`;
                        evalStatusEl.className = 'text-orange-600 font-semibold';
                    }
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
                console.error('Stats error details:', error.message);
                
                // Defensive checks for error handling
                const vectorCountEl = document.getElementById('vectorCount');
                if (vectorCountEl) {
                    vectorCountEl.textContent = 'Error';
                    vectorCountEl.className = 'font-semibold text-red-600';
                } else {
                    console.error("Critical: DOM element 'vectorCount' not found in HTML");
                }
                
                const dbStatusEl = document.getElementById('dbStatus');
                if (dbStatusEl) {
                    dbStatusEl.textContent = 'Error';
                    dbStatusEl.className = 'font-semibold text-red-600';
                } else {
                    console.error("Critical: DOM element 'dbStatus' not found in HTML");
                }
                
                const trialDaysEl = document.getElementById('trialDays');
                if (trialDaysEl) {
                    trialDaysEl.textContent = 'Error';
                    trialDaysEl.className = 'font-semibold text-red-600';
                } else {
                    console.error("Critical: DOM element 'trialDays' not found in HTML");
                }
            }
        }

        // Load and display rules
        async function loadRules() {
            try {
                const response = await fetch('/api/v1/rules');
                const data = await response.json();
                const rulesList = document.getElementById('rulesList');
                
                if (!data.rules || data.rules.length === 0) {
                    rulesList.innerHTML = '<p class="text-gray-500 text-sm italic">No rules defined</p>';
                    return;
                }
                
                rulesList.innerHTML = data.rules.map(rule => `
                    <div class="flex items-center justify-between bg-gray-50 p-3 rounded border ${rule.active ? 'border-green-300' : 'border-gray-300'}">
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-900">${escapeHtml(rule.query)}</p>
                            <p class="text-xs text-gray-500 mt-1">
                                ${rule.active ? '<span class="text-green-600">‚óè Active</span>' : '<span class="text-gray-400">‚óã Inactive</span>'}
                            </p>
                        </div>
                        <div class="flex gap-2 ml-4">
                            <button onclick="toggleRule(${rule.id}, ${!rule.active})" 
                                    class="px-2 py-1 text-xs ${rule.active ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'} rounded hover:opacity-80">
                                ${rule.active ? 'Deactivate' : 'Activate'}
                            </button>
                            <button onclick="deleteRule(${rule.id})" 
                                    class="px-2 py-1 text-xs bg-red-100 text-red-700 rounded hover:opacity-80">
                                Delete
                            </button>
                        </div>
                    </div>
                `).join('');
                console.log("[loadRules] Rules rendered to DOM successfully");
            } catch (error) {
                console.error('[loadRules] Failed to load rules:', error);
                const rulesList = document.getElementById('rulesList');
                if (rulesList) {
                    rulesList.innerHTML = '<p class="text-red-500 text-sm">Failed to load rules: ' + error.message + '</p>';
                } else {
                    console.error('[loadRules] Cannot show error - rulesList element not found');
                }
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function addRule(event) {
            // Prevent form submission and page reload
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            console.log('Add Rule clicked');
            const queryInput = document.getElementById('newRuleQuery');
            const activeCheckbox = document.getElementById('newRuleActive');
            const addButton = document.getElementById('addRuleButton');
            
            if (!queryInput) {
                console.error('newRuleQuery input not found');
                alert('Error: Rule input field not found');
                return;
            }
            
            const query = queryInput.value.trim();
            const active = activeCheckbox ? activeCheckbox.checked : true;
            
            console.log('Rule query:', query, 'Active:', active);
            
            if (!query) {
                alert('Please enter a rule query');
                return;
            }
            
            // Set loading state
            if (addButton) {
                addButton.disabled = true;
                addButton.textContent = 'Adding...';
            }
            
            console.log('Sending POST to /api/v1/rules');
            fetch('/api/v1/rules', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({query, active})
            })
            .then(response => {
                console.log("Raw Server Response:", response);
                console.log("Response status:", response.status);
                console.log("Response ok:", response.ok);
                console.log("Response headers:", response.headers);
                
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error("Server error response body:", text);
                        throw new Error("Status: " + response.status + ": " + text);
                    });
                }
                
                // Use .text() first to debug empty bodies
                return response.text();
            })
            .then(text => {
                console.log("Server Body (raw):", text);
                console.log("Server Body length:", text ? text.length : 0);
                
                // Parse JSON if body exists
                if (!text || text.trim() === '') {
                    console.warn("Empty response body from server");
                    return {};
                }
                
                try {
                    const parsed = JSON.parse(text);
                    console.log("Parsed Data:", parsed);
                    return parsed;
                } catch (e) {
                    console.error("Failed to parse JSON:", e, "Text was:", text);
                    throw new Error("Invalid JSON response: " + text.substring(0, 100));
                }
            })
            .then(data => {
                console.log("Rule added successfully, parsed data:", data);
                // Clear input field only on success
                queryInput.value = "";
                console.log("Input cleared, calling loadRules()...");
                loadRules(); // Refresh list
                console.log("loadRules() called");
            })
            .catch(err => {
                console.error("Fetch Chain Broke:", err);
                alert("Error adding rule: " + err.message);
            })
            .finally(() => {
                // Re-enable button and restore text in all cases (success or error)
                if (addButton) {
                    addButton.disabled = false;
                    addButton.textContent = 'Add Rule';
                }
            });
        }

        async function toggleRule(id, active) {
            try {
                const response = await fetch(`/api/v1/rules/update?id=${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({query: '', active: active}) // Query will be ignored, only active is updated
                });
                
                if (response.ok) {
                    await loadRules();
                } else {
                    alert('Failed to update rule');
                }
            } catch (error) {
                console.error('Error updating rule:', error);
                alert('Error: ' + error.message);
            }
        }

        async function deleteRule(id) {
            if (!confirm('Delete this rule?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/v1/rules/delete?id=${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    await loadRules();
                } else {
                    alert('Failed to delete rule');
                }
            } catch (error) {
                console.error('Error deleting rule:', error);
                alert('Error: ' + error.message);
            }
        }

        // Tab management
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active state from all tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('border-blue-500', 'text-blue-600');
                button.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected tab content
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            
            // Activate selected tab button
            const tabButton = document.getElementById(`tab-${tabName}`);
            tabButton.classList.remove('border-transparent', 'text-gray-500');
            tabButton.classList.add('border-blue-500', 'text-blue-600');
            
            // Load audit logs if switching to audit tab
            if (tabName === 'audit') {
                loadAuditLogs();
            }
        }

        // Load audit logs
        async function loadAuditLogs() {
            const tableBody = document.getElementById('auditLogsTable');
            tableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Loading...</td></tr>';
            
            try {
                const response = await fetch('/api/v1/audit?limit=50');
                const data = await response.json();
                
                if (!data.logs || data.logs.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No audit logs found</td></tr>';
                    return;
                }
                
                tableBody.innerHTML = data.logs.map(log => {
                    const timestamp = new Date(log.timestamp).toLocaleString();
                    const actionBadge = log.action === 'SEARCH' 
                        ? '<span class="px-2 py-1 text-xs font-semibold rounded bg-blue-100 text-blue-800">SEARCH</span>'
                        : '<span class="px-2 py-1 text-xs font-semibold rounded bg-green-100 text-green-800">INGEST</span>';
                    
                    return `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${escapeHtml(timestamp)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${escapeHtml(log.client_ip)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${actionBadge}</td>
                            <td class="px-6 py-4 text-sm text-gray-700">${escapeHtml(log.details)}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Failed to load audit logs:', error);
                tableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-red-500">Failed to load audit logs</td></tr>';
            }
        }

        // API Key Management Functions
        async function loadAPIKeys() {
            const keysList = document.getElementById('apiKeysList');
            keysList.innerHTML = '<p class="text-gray-500 text-sm">Loading keys...</p>';
            
            try {
                const response = await fetch('/api/v1/keys');
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Key Manager: Error response:', errorText);
                    alert('Failed to load API keys: ' + errorText);
                    keysList.innerHTML = '<p class="text-red-500 text-sm">Failed to load keys</p>';
                    return;
                }
                
                const data = await response.json();
                // Received data
                
                if (!data.keys || data.keys.length === 0) {
                    keysList.innerHTML = '<p class="text-gray-500 text-sm italic">No API keys found. Generate one to get started.</p>';
                    return;
                }
                
                // Populate server API key selector
                const serverKeySelect = document.getElementById('serverApiKeySelect');
                if (serverKeySelect) {
                    // Clear existing options except the first one
                    while (serverKeySelect.options.length > 1) {
                        serverKeySelect.remove(1);
                    }
                    
                    // Add active keys to selector
                    data.keys.filter(key => key.is_active).forEach(key => {
                        const option = document.createElement('option');
                        option.value = key.key;
                        option.textContent = `${key.client_name} (${key.key.substring(0, 20)}...)`;
                        serverKeySelect.appendChild(option);
                    });
                }
                
                // Load saved server API key from localStorage
                const savedServerKey = localStorage.getItem('hive_api_key');
                const serverApiKeyInput = document.getElementById('serverApiKey');
                if (savedServerKey && serverApiKeyInput) {
                    serverApiKeyInput.value = savedServerKey;
                    // Select matching option if it exists
                    if (serverKeySelect) {
                        for (let i = 0; i < serverKeySelect.options.length; i++) {
                            if (serverKeySelect.options[i].value === savedServerKey) {
                                serverKeySelect.selectedIndex = i;
                                break;
                            }
                        }
                    }
                }
                
                // Don't auto-save first active key - user must explicitly configure it
                // This prevents confusion between client keys and server key
                
                keysList.innerHTML = data.keys.map(key => {
                    const statusDot = key.is_online 
                        ? '<span class="inline-block w-3 h-3 rounded-full bg-green-500 mr-2" title="Online"></span>'
                        : '<span class="inline-block w-3 h-3 rounded-full bg-red-500 mr-2" title="Offline"></span>';
                    const statusText = key.is_online ? 'üü¢ Online' : 'üî¥ Offline';
                    const lastSeen = key.last_seen_at 
                        ? new Date(key.last_seen_at).toLocaleString() 
                        : 'Never';
                    
                    return `
                        <div class="flex items-center justify-between bg-gray-50 p-3 rounded border ${key.is_active ? 'border-green-300' : 'border-gray-300'}">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    ${statusDot}
                                    <p class="text-sm font-medium text-gray-900">${escapeHtml(key.client_name)}</p>
                                    <span class="text-xs text-gray-500">(${statusText})</span>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">
                                    Key: <code class="bg-gray-200 px-1 rounded">${escapeHtml(key.key.substring(0, 20))}...</code>
                                </p>
                                <p class="text-xs text-gray-400 mt-1">
                                    Created: ${new Date(key.created_at).toLocaleString()} | Last seen: ${lastSeen}
                                </p>
                            </div>
                            <div class="flex gap-2 ml-4">
                                ${key.is_active 
                                    ? `<button onclick="revokeKey('${escapeHtml(key.key)}')" class="px-2 py-1 text-xs bg-red-100 text-red-700 rounded hover:opacity-80">Revoke</button>`
                                    : '<span class="text-xs text-gray-400">Revoked</span>'
                                }
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('API Key Manager: Error loading keys:', error);
                alert('Error loading API keys: ' + error.message);
                keysList.innerHTML = '<p class="text-red-500 text-sm">Error loading keys</p>';
            }
        }

        async function generateKey() {
            console.log('API Key Manager: Generating new key...');
            const clientName = document.getElementById('newClientName').value.trim() || 'Unnamed Client';
            const newKeyDisplay = document.getElementById('newKeyDisplay');
            const newKeyValue = document.getElementById('newKeyValue');
            
            try {
                // Sending request with client_name
                const response = await fetch('/api/v1/keys/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ client_name: clientName }),
                });
                
                // Response received
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Key Manager: Error response:', errorText);
                    alert('Failed to generate key: ' + errorText);
                    return;
                }
                
                const data = await response.json();
                // Key generated successfully
                
                newKeyValue.textContent = data.key;
                newKeyDisplay.classList.remove('hidden');
                document.getElementById('newClientName').value = '';
                
                // Reload keys list
                await loadAPIKeys();
            } catch (error) {
                console.error('API Key Manager: Error generating key:', error);
                alert('Error generating key: ' + error.message);
            }
        }

        async function revokeKey(key) {
            if (!confirm('Revoke this API key? The client will no longer be able to connect.')) {
                return;
            }
            
            // Revoking key
            try {
                const response = await fetch('/api/v1/keys/revoke', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ key: key }),
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    alert('Failed to revoke key: ' + errorText);
                    return;
                }
                
                await loadAPIKeys();
            } catch (error) {
                console.error('API Key Manager: Error revoking key:', error);
                alert('Error revoking key: ' + error.message);
            }
        }

        // Initialize
        loadConfig();
        loadStats();
        loadRules();
        loadAPIKeys(); // Load API keys on page load
        connectLogStream();
        
        // Update stats every 5 seconds
        setInterval(loadStats, 10000);
        // Reload API keys every 10 seconds to update online status
        setInterval(loadAPIKeys, 10000); // Already 10 seconds
    </script>
{{ end }}

{{ define "scripts" }}
<script>
    // Load evaluation status for footer
    async function loadEvaluationStatus() {
        try {
            const response = await fetch('/api/v1/stats');
            const stats = await response.json();
            const days = stats.trial_days || 0;
            const evalStatusEl = document.getElementById('evaluationStatus');
            if (evalStatusEl) {
                if (days > 365) {
                    evalStatusEl.textContent = `Evaluation Mode: Day ${days} of 365 (Expired - License Required)`;
                    evalStatusEl.className = 'text-center text-sm text-red-600 font-semibold';
                } else {
                    evalStatusEl.textContent = `Evaluation Mode: Day ${days} of 365`;
                    evalStatusEl.className = 'text-center text-sm text-orange-600 font-semibold';
                }
            }
        } catch (error) {
            console.error('Failed to load evaluation status:', error);
        }
    }
    
    loadEvaluationStatus();
    setInterval(loadEvaluationStatus, 5000);
</script>
{{ end }}

