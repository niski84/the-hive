<!--
Copyright (c) 2025 Northbound System
Author: Nicholas Skitch
-->
{{ define "title" }}Search - The Hive{{ end }}

{{ define "head" }}
<style>
    .result-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .result-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    .loading {
        display: none;
    }
    .loading.active {
        display: inline-block;
    }
</style>
{{ end }}

{{ define "content" }}
<div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-900 mb-2">üêù The Hive</h1>
        <p class="text-gray-600">Vector Search Interface</p>
    </div>

    <!-- Search Interface -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex gap-4">
            <input 
                type="text" 
                id="searchInput" 
                placeholder="Enter your search query..."
                class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-lg"
            />
            <button 
                id="searchButton"
                onclick="performSearch()"
                class="px-8 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
            >
                <span id="buttonText">Search</span>
                <span id="loadingSpinner" class="loading">‚è≥</span>
            </button>
        </div>
    </div>

    <!-- Results Container -->
    <div id="resultsContainer" class="space-y-4">
        <!-- Results will be rendered here -->
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="text-center py-12 text-gray-500">
        <p class="text-lg">Enter a search query above to find relevant documents</p>
    </div>
</div>
{{ end }}

{{ define "scripts" }}
<script>
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const buttonText = document.getElementById('buttonText');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const resultsContainer = document.getElementById('resultsContainer');
    const emptyState = document.getElementById('emptyState');

    // Handle Enter key press
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performSearch();
        }
    });

    async function performSearch() {
        const query = searchInput.value.trim();
        if (!query) {
            alert('Please enter a search query');
            return;
        }

        // Show loading state
        searchButton.disabled = true;
        buttonText.textContent = 'Searching...';
        loadingSpinner.classList.add('active');
        resultsContainer.innerHTML = '';
        emptyState.style.display = 'none';

        try {
            const response = await fetch('/api/v1/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    query: query,
                    top_k: 3
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Search failed');
            }

            const data = await response.json();
            console.log('Search response:', data);
            console.log('First match:', data.matches?.[0]);
            renderResults(data);
        } catch (error) {
            console.error('Search error:', error);
            resultsContainer.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <p class="text-red-800">Error: ${error.message}</p>
                </div>
            `;
        } finally {
            // Reset button state
            searchButton.disabled = false;
            buttonText.textContent = 'Search';
            loadingSpinner.classList.remove('active');
        }
    }

    function renderResults(data) {
        if (!data.matches || data.matches.length === 0) {
            emptyState.style.display = 'block';
            emptyState.innerHTML = '<p class="text-lg">No results found</p>';
            return;
        }

        emptyState.style.display = 'none';
        resultsContainer.innerHTML = '';

        data.matches.forEach((match, index) => {
            console.log(`Match ${index}:`, match);
            const card = document.createElement('div');
            card.className = 'result-card bg-white rounded-lg shadow-md p-6';
            
            // Extract filename from metadata or use document_id
            const filename = match.metadata?.filename || match.document_id || 'Unknown';
            const score = (match.score * 100).toFixed(1);
            // Try multiple possible content fields
            let content = match.content || match.text || match.payload?.content || match.metadata?.content || 'No content available';
            if (content && content.length > 50) {
                console.log(`Content for match ${index}:`, content.substring(0, 50) + '...');
            } else {
                console.log(`Content for match ${index}:`, content);
            }
            
            // Truncate content if too long
            const maxLength = 300;
            const truncatedContent = content.length > maxLength 
                ? content.substring(0, maxLength) + '...' 
                : content;

            card.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h3 class="text-xl font-semibold text-gray-900">${escapeHtml(filename)}</h3>
                        <p class="text-sm text-gray-500 mt-1">Document: ${escapeHtml(match.document_id)}</p>
                    </div>
                    <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">
                        ${score}% match
                    </div>
                </div>
                <div class="text-gray-700 leading-relaxed">
                    ${escapeHtml(truncatedContent)}
                </div>
                ${match.metadata?.filetype ? `
                    <div class="mt-3 pt-3 border-t border-gray-200">
                        <span class="text-xs text-gray-500">Type: ${escapeHtml(match.metadata.filetype)}</span>
                    </div>
                ` : ''}
            `;

            resultsContainer.appendChild(card);
        });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Load evaluation status
    async function loadEvaluationStatus() {
        try {
            const response = await fetch('/api/v1/stats');
            const stats = await response.json();
            const days = stats.trial_days || 0;
            const evalStatusEl = document.getElementById('evaluationStatus');
            if (evalStatusEl) {
                if (days > 365) {
                    evalStatusEl.textContent = `Evaluation Mode: Day ${days} of 365 (Expired - License Required)`;
                    evalStatusEl.className = 'text-center text-sm text-red-600 font-semibold';
                } else {
                    evalStatusEl.textContent = `Evaluation Mode: Day ${days} of 365`;
                    evalStatusEl.className = 'text-center text-sm text-orange-600 font-semibold';
                }
            }
        } catch (error) {
            console.error('Failed to load evaluation status:', error);
        }
    }
    
    loadEvaluationStatus();
</script>
{{ end }}
